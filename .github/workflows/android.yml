name: Android signed release

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: 'Release notes (optional)'
        required: false
      version_override:
        description: 'Override version tag (e.g., v1.2.3)'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required for creating releases
    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      KEYSTORE_PATH: app/keystore.jks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Make gradlew executable
        run: chmod +x ViewInspector/gradlew

      - name: Decode keystore (from SECRET) to file
        if: ${{ env.KEYSTORE_BASE64 != '' }}  # FIXED: Valid expression syntax
        run: |
          echo "Decoding keystore to ViewInspector/app/keystore.jks"
          mkdir -p ViewInspector/app
          echo "$KEYSTORE_BASE64" | base64 --decode > ViewInspector/app/keystore.jks
          echo "✓ Keystore decoded successfully"

      - name: Debug keystore (non-critical)
        if: ${{ env.KEYSTORE_BASE64 != '' }}
        continue-on-error: true  # Prevent workflow failure on debug step
        run: |
          echo "Validating keystore..."
          keytool -list -v \
            -keystore ViewInspector/app/keystore.jks \
            -storepass "$KEYSTORE_PASSWORD" \
            -alias "$KEY_ALIAS" 2>&1 || echo "⚠ Keystore validation failed (non-critical)"

      - name: Verify keystore exists for signing
        if: ${{ env.KEYSTORE_BASE64 != '' }}
        run: |
          if [ ! -f "ViewInspector/app/keystore.jks" ]; then
            echo "❌ Keystore file missing at expected path!"
            exit 1
          fi
          echo "✓ Keystore found at ViewInspector/app/keystore.jks"

      - name: Build release APK
        run: |
          cd ViewInspector
          ./gradlew :app:assembleRelease --no-daemon -Pandroid.injected.testOnly=false
          # Verify signed APK was generated
          if [ ! -f "app/build/outputs/apk/release/app-release.apk" ]; then
            echo "❌ Signed APK not found after build!"
            exit 1
          fi
          echo "✓ Signed APK generated successfully"

      - name: Upload signed APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: viewinspector-release-apk
          path: ViewInspector/app/build/outputs/apk/release/app-release.apk

      - name: Create GitHub Release
        if: ${{ success() && (github.event.inputs.version_override != '' || env.KEYSTORE_BASE64 != '') }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          REPO="${{ github.repository }}"
          VERSION_TAG=""
          
          # Use override if provided
          if [[ -n "${{ github.event.inputs.version_override }}" ]]; then
            VERSION_TAG="${{ github.event.inputs.version_override }}"
            # Ensure v-prefix consistency
            [[ "$VERSION_TAG" != v* ]] && VERSION_TAG="v$VERSION_TAG"
          else
            # Get latest release tag safely
            LATEST_TAG=$(gh release list --repo "$REPO" --limit 1 --json tagName --jq '.[0].tagName // "v0.0.0"' 2>/dev/null)
            
            # Robust version parsing with fallbacks
            VERSION_NUM="${LATEST_TAG#v}"
            IFS='.' read -r MAJOR MINOR PATCH <<< "${VERSION_NUM:-0.0.0}"
            MAJOR="${MAJOR:-0}"
            MINOR="${MINOR:-0}"
            PATCH="${PATCH:-0}"
            
            # Increment patch version
            PATCH=$((PATCH + 1))
            VERSION_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          echo "Creating release: $VERSION_TAG"
          
          # Prepare release notes
          RELEASE_NOTES="## ViewInspector $VERSION_TAG

This is the official release of ViewInspector.

### Features
- Android view inspection tool
- Support for signed release builds

### Downloads
- **app-release.apk**: Signed Android APK file, ready to install

### Requirements
- Android 7.0 (API 24) or higher
- Recommended to test on real devices for best experience"
          
          # Append custom notes if provided
          if [[ -n "${{ github.event.inputs.release_notes }}" ]]; then
            RELEASE_NOTES="${RELEASE_NOTES}

### Update Notes
${{ github.event.inputs.release_notes }}"
          fi
          
          # Create release with proper error handling
          if gh release view "$VERSION_TAG" --repo "$REPO" &>/dev/null; then
            echo "⚠ Release $VERSION_TAG already exists. Updating assets..."
            gh release upload "$VERSION_TAG" \
              ViewInspector/app/build/outputs/apk/release/app-release.apk \
              --repo "$REPO" \
              --clobber
          else
            gh release create "$VERSION_TAG" \
              ViewInspector/app/build/outputs/apk/release/app-release.apk \
              --title "ViewInspector $VERSION_TAG" \
              --notes "$RELEASE_NOTES" \
              --repo "$REPO"
          fi
          
          echo "✓ Release created successfully: https://github.com/$REPO/releases/tag/$VERSION_TAG"
