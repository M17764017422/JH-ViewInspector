name: Android 签名发布

on:
  workflow_dispatch:
    inputs:
      release_notes:
        description: '更新说明（可选）'
        required: false
      version_override:
        description: '覆盖版本标签（例如：v1.2.3）'
        required: false

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    env:
      KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
      KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 设置 JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: 赋予 gradlew 执行权限
        run: chmod +x ViewInspector/gradlew

      - name: 解码密钥库文件
        if: ${{ env.KEYSTORE_BASE64 != '' }}
        run: |
          echo "正在解码密钥库到 ViewInspector/app/keystore.jks"
          mkdir -p ViewInspector/app
          echo "$KEYSTORE_BASE64" | base64 --decode > ViewInspector/app/keystore.jks
          echo "✓ 密钥库解码完成"

      - name: 验证密钥库（调试用）
        if: ${{ env.KEYSTORE_BASE64 != '' }}
        continue-on-error: true
        run: |
          echo "正在验证密钥库..."
          keytool -list -v -keystore ViewInspector/app/keystore.jks -storepass "$KEYSTORE_PASSWORD" -alias "$KEY_ALIAS" 2>&1 || echo "⚠ 密钥库验证失败（不影响构建）"

      - name: 构建签名 APK
        run: |
          cd ViewInspector
          ./gradlew :app:assembleRelease --no-daemon -Pandroid.injected.testOnly=false
          if [ ! -f "app/build/outputs/apk/release/app-release.apk" ]; then
            echo "❌ 未找到签名 APK 文件！"
            exit 1
          fi
          echo "✓ 签名 APK 构建成功"

      - name: 上传 APK 到构件
        uses: actions/upload-artifact@v4
        with:
          name: viewinspector-release-apk
          path: ViewInspector/app/build/outputs/apk/release/app-release.apk

      - name: 创建 GitHub 发布版本
        if: ${{ success() }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 确定版本标签
          if [[ -n "${{ github.event.inputs.version_override }}" ]]; then
            VERSION_TAG="${{ github.event.inputs.version_override }}"
            [[ "$VERSION_TAG" != v* ]] && VERSION_TAG="v$VERSION_TAG"
          else
            LATEST_TAG=$(gh release list --repo ${{ github.repository }} --limit 1 --json tagName --jq '.[0].tagName // "v0.0.0"' 2>/dev/null)
            VERSION_NUM="${LATEST_TAG#v}"
            IFS='.' read -r MAJOR MINOR PATCH <<< "${VERSION_NUM:-0.0.0}"
            MAJOR="${MAJOR:-0}"
            MINOR="${MINOR:-0}"
            PATCH="${PATCH:-0}"
            PATCH=$((PATCH + 1))
            VERSION_TAG="v${MAJOR}.${MINOR}.${PATCH}"
          fi
          
          echo "正在创建发布版本: $VERSION_TAG"
          
          # 生成发布说明（使用 echo 避免 YAML 解析错误）
          echo "## ViewInspector $VERSION_TAG" > release_notes.txt
          echo "" >> release_notes.txt
          echo "ViewInspector 官方发布版本" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "### 功能特点" >> release_notes.txt
          echo "- Android 视图检查工具" >> release_notes.txt
          echo "- 支持签名发布版本构建" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "### 下载文件" >> release_notes.txt
          echo "- **app-release.apk**：已签名的 Android 安装包，可直接安装使用" >> release_notes.txt
          echo "" >> release_notes.txt
          echo "### 使用要求" >> release_notes.txt
          echo "- 需要 Android 7.0 或更高版本" >> release_notes.txt
          echo "- 建议在真实设备上测试以获得最佳体验" >> release_notes.txt
          
          # 添加自定义更新说明（如果提供）
          if [[ -n "${{ github.event.inputs.release_notes }}" ]]; then
            echo "" >> release_notes.txt
            echo "### 本次更新内容" >> release_notes.txt
            echo "${{ github.event.inputs.release_notes }}" >> release_notes.txt
          fi
          
          # 创建发布版本
          gh release create "$VERSION_TAG" \
            ViewInspector/app/build/outputs/apk/release/app-release.apk \
            --title "ViewInspector $VERSION_TAG" \
            --notes-file release_notes.txt \
            --repo ${{ github.repository }}
          
          echo "✓ 发布版本创建成功：https://github.com/${{ github.repository }}/releases/tag/$VERSION_TAG"
